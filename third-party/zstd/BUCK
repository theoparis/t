zstd_common_sources = [
    "lib/common/debug.c",
    "lib/common/entropy_common.c",
    "lib/common/error_private.c",
    "lib/common/fse_decompress.c",
    "lib/common/pool.c",
    "lib/common/threading.c",
    "lib/common/xxhash.c",
    "lib/common/zstd_common.c",
]

zstd_decompress_sources = [
    "lib/decompress/huf_decompress.c",
    "lib/decompress/zstd_ddict.c",
    "lib/decompress/zstd_decompress.c",
    "lib/decompress/zstd_decompress_block.c",
]

zstd_compress_sources = [
    "lib/compress/fse_compress.c",
    "lib/compress/hist.c",
    "lib/compress/huf_compress.c",
    "lib/compress/zstd_compress.c",
    "lib/compress/zstd_compress_literals.c",
    "lib/compress/zstd_compress_sequences.c",
    "lib/compress/zstd_compress_superblock.c",
    "lib/compress/zstd_double_fast.c",
    "lib/compress/zstd_fast.c",
    "lib/compress/zstd_lazy.c",
    "lib/compress/zstd_ldm.c",
    "lib/compress/zstd_opt.c",
    "lib/compress/zstdmt_compress.c",
    "lib/compress/zstd_preSplit.c",
]

zstd_sources = zstd_common_sources + zstd_decompress_sources + zstd_compress_sources

zstd_common_headers = [
    "lib/common/allocations.h",
    "lib/common/bits.h",
    "lib/common/bitstream.h",
    "lib/common/compiler.h",
    "lib/common/cpu.h",
    "lib/common/debug.h",
    "lib/common/error_private.h",
    "lib/common/fse.h",
    "lib/common/huf.h",
    "lib/common/mem.h",
    "lib/common/pool.h",
    "lib/common/portability_macros.h",
    "lib/common/threading.h",
    "lib/common/xxhash.h",
    "lib/common/zstd_deps.h",
    "lib/common/zstd_internal.h",
    "lib/common/zstd_trace.h",
]

zstd_decompress_headers = [
    "lib/decompress/zstd_ddict.h",
    "lib/decompress/zstd_decompress_block.h",
    "lib/decompress/zstd_decompress_internal.h",
]

zstd_compress_headers = [
    "lib/compress/clevels.h",
    "lib/compress/hist.h",
    "lib/compress/zstd_compress_internal.h",
    "lib/compress/zstd_compress_literals.h",
    "lib/compress/zstd_compress_sequences.h",
    "lib/compress/zstd_compress_superblock.h",
    "lib/compress/zstd_cwksp.h",
    "lib/compress/zstd_double_fast.h",
    "lib/compress/zstd_fast.h",
    "lib/compress/zstd_lazy.h",
    "lib/compress/zstd_ldm.h",
    "lib/compress/zstd_opt.h",
    "lib/compress/zstdmt_compress.h",
    "lib/compress/zstd_preSplit.h",
]

zstd_exported_headers = [
    "lib/zstd.h",
    "lib/zstd_errors.h",
]

zstd_headers = (
    zstd_common_headers +
    zstd_decompress_headers +
    zstd_compress_headers +
    zstd_exported_headers
)

http_archive(
    name = "src",
    sha256 = "37d7284556b20954e56e1ca85b80226768902e2edabd3b649e9e72c0c9012ee3",
    strip_prefix = "zstd-1.5.7",
    urls = ["https://github.com/facebook/zstd/archive/refs/tags/v1.5.7.tar.gz"],
    sub_targets = zstd_sources + zstd_headers,
    visibility = ["third-party//zstd/..."],
)

src_ref = lambda x: ":src[{}]".format(x)

cxx_library(
    name = "zstd",
    srcs = [src_ref(f) for f in zstd_sources],
    headers = [src_ref(f) for f in zstd_common_headers + zstd_decompress_headers + zstd_compress_headers],
    exported_headers = {
        "zstd.h": src_ref("lib/zstd.h"),
        "zstd_errors.h": src_ref("lib/zstd_errors.h"),
    },
    header_namespace = "",
    compiler_flags = [
        "-DZSTD_MULTITHREAD",
        "-DZSTD_DISABLE_ASM",
        "-Ithird-party//zstd:src[lib/common]",
        "-Ithird-party//zstd:src[lib/decompress]",
        "-Ithird-party//zstd:src[lib/compress]",
    ],
    preferred_linkage = "static",
    visibility = ["PUBLIC"],
)
